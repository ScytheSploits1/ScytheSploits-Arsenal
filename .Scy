--// Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Drawing = Drawing or {}

--// Variables
local aimAtPart = "Head" -- Default to Head, can be changed in the dropdown
local aimbotEnabled = false
local InfiniteJumpEnabled = false
local fovRadius = 60 -- Reduced FOV circle radius (smaller than 80)
local targetPlayer = nil -- The current target player
local espEnabled = false
local silentAimEnabled = false -- Silent Aim toggle
local ammoCount = 999 -- Infinite Ammo logic
local fovCircleVisible = true -- FOV Circle Visibility
local speedHackEnabled = false -- Speed Hack toggle
local speedHackSpeed = 100 -- Default speed hack speed
local teleportHeight = 5 -- Height offset for teleportation
local tpToEnemyEnabled = false -- TP to Enemy toggle

--// Drawing Setup
local fovCircle = Drawing.new("Circle")
fovCircle.Visible = fovCircleVisible
fovCircle.Color = Color3.fromRGB(255, 0, 0) -- Red color
fovCircle.Thickness = 1
fovCircle.Filled = false

local function updateFovCircle()
    local mouseLocation = UserInputService:GetMouseLocation()
    fovCircle.Position = mouseLocation
    fovCircle.Radius = fovRadius
end

local function getClosestTarget()
    local closestTarget = nil
    local closestDistance = fovRadius
    local camera = workspace.CurrentCamera

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(aimAtPart) then
            if player.Team ~= LocalPlayer.Team then -- Team check to avoid targeting teammates
                local targetPart = player.Character:FindFirstChild(aimAtPart)
                if targetPart then
                    local screenPoint, onScreen = camera:WorldToViewportPoint(targetPart.Position)
                    if onScreen then
                        local distance = (Vector2.new(screenPoint.X, screenPoint.Y) - UserInputService:GetMouseLocation()).magnitude
                        if distance < closestDistance then
                            closestTarget = player
                            closestDistance = distance
                        end
                    end
                end
            end
        end
    end

    return closestTarget
end

local function aimAtTarget()
    while aimbotEnabled do
        local target = getClosestTarget()
        if target then
            local character = target.Character
            if character and character:FindFirstChild(aimAtPart) then
                local targetPart = character:FindFirstChild(aimAtPart)
                if targetPart then
                    local targetPosition = targetPart.Position
                    local targetCFrame = CFrame.new(Camera.CFrame.Position, targetPosition)
                    Camera.CFrame = targetCFrame -- Instant aiming
                    targetPlayer = target -- Set the target player
                end
            end
        end
        RunService.RenderStepped:Wait() -- Ensure this runs as often as possible
        if not aimbotEnabled then break end -- Stop the loop if aimbot is disabled
    end
end

local function updateAmmo()
    RunService.RenderStepped:Connect(function()
        local Gun = game.Players.LocalPlayer.PlayerGui.GUI.Client.Variables.gun.Value
        if Gun and game.Players.LocalPlayer.PlayerGui.GUI.Client.Variables.ammocount then
            game.Players.LocalPlayer.PlayerGui.GUI.Client.Variables.ammocount.Value = ammoCount
        end
    end)
end

-- Silent Aim Logic
local function silentAim()
    if silentAimEnabled then
        local target = getClosestTarget()
        if target then
            -- Silent aim logic would go here
        end
    end
end

-- New ESP Logic with Health Bar and Smaller Name Tags
local function createESP(player)
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") and player.Team ~= LocalPlayer.Team then -- Team check in ESP
        -- Create a Box around the character
        local box = Drawing.new("Square")
        box.Visible = true
        box.Color = Color3.fromRGB(255, 0, 0) -- Red color for enemy
        box.Thickness = 1
        box.Filled = false

        -- Create the ESP Name Tag
        local nameTag = Drawing.new("Text")
        nameTag.Visible = true
        nameTag.Center = true
        nameTag.Outline = true
        nameTag.Color = Color3.fromRGB(255, 255, 255) -- White color for name tag
        nameTag.Size = 10 -- Smaller size for name tag
        nameTag.Text = player.Name

        -- Create the Health Bar
        local healthBarOutline = Drawing.new("Square")
        healthBarOutline.Visible = true
        healthBarOutline.Color = Color3.new(0, 0, 0) -- Black outline for the health bar
        healthBarOutline.Thickness = 1
        healthBarOutline.Filled = false

        local healthBar = Drawing.new("Square")
        healthBar.Visible = true
        healthBar.Thickness = 1
        healthBar.Filled = true

        -- Update the ESP Position
        local function updateESP()
            if espEnabled and character and character:FindFirstChild("HumanoidRootPart") then
                local rootPart = character:FindFirstChild("HumanoidRootPart")
                local rootPosition, onScreen = Camera:WorldToViewportPoint(rootPart.Position)

                if onScreen then
                    local humanoid = character:FindFirstChild("Humanoid")
                    if humanoid then
                        local healthPercent = humanoid.Health / humanoid.MaxHealth
                        local healthColor = Color3.fromRGB(255 * (1 - healthPercent), 255 * healthPercent, 0) -- Green to red based on health

                        -- Set Box Position
                        box.Size = Vector2.new(2000 / rootPosition.Z, 3000 / rootPosition.Z) -- Scale with distance
                        box.Position = Vector2.new(rootPosition.X - box.Size.X / 2, rootPosition.Y - box.Size.Y / 2)
                        box.Visible = true

                        -- Set NameTag Position
                        nameTag.Position = Vector2.new(rootPosition.X, rootPosition.Y - box.Size.Y / 2 - 15)
                        nameTag.Visible = true

                        -- Set Health Bar Position
                        healthBarOutline.Size = Vector2.new(2, box.Size.Y) -- Health bar outline size
                        healthBarOutline.Position = Vector2.new(box.Position.X - 6, box.Position.Y)
                        healthBarOutline.Visible = true

                        healthBar.Size = Vector2.new(2, box.Size.Y * healthPercent) -- Health bar size
                        healthBar.Position = Vector2.new(box.Position.X - 6, box.Position.Y + (box.Size.Y * (1 - healthPercent)))
                        healthBar.Color = healthColor -- Set health bar color based on health percentage
                        healthBar.Visible = true
                    end
                else
                    box.Visible = false
                    nameTag.Visible = false
                    healthBar.Visible = false
                    healthBarOutline.Visible = false
                end
            else
                box.Visible = false
                nameTag.Visible = false
                healthBar.Visible = false
                healthBarOutline.Visible = false
            end
        end

        -- Run the update function on each frame
        RunService.RenderStepped:Connect(updateESP)
    end
end

local function enableNewESP()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createESP(player)
        end
    end
end

local function monitorNewPlayers()
    Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function()
            if espEnabled then
                createESP(player)
            end
        end)
    end)
end

-- Anti-Cheat Detection and Bypass
local function detectAndBypassAntiCheat()
    local function checkForAntiCheat()
        local detected = false
        local antiCheatObjects = {"AntiCheat", "AntiCheatScript", "AntiCheatModule"}
        for _, objName in ipairs(antiCheatObjects) do
            if workspace:FindFirstChild(objName) or ReplicatedStorage:FindFirstChild(objName) then
                detected = true
                break
            end
        end
        return detected
    end

    local function removeAntiCheatObjects()
        local antiCheatObjects = {"AntiCheat", "AntiCheatScript", "AntiCheatModule"}
        for _, objName in ipairs(antiCheatObjects) do
            local obj = workspace:FindFirstChild(objName) or ReplicatedStorage:FindFirstChild(objName)
            if obj then
                obj:Destroy()
            end
        end
    end

    local detected = checkForAntiCheat()
    if detected then
        print("Anti-Cheat Detected!")
        removeAntiCheatObjects()
        print("Anti-Cheat Objects Removed!")
    else
        print("Anti-Cheat Not Detected.")
    end
end

-- TP to Enemy Logic
local function tpToEnemy()
    while tpToEnemyEnabled do
        local nearestPlayer = nil
        local shortestDistance = math.huge

        -- Find the nearest enemy player
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Team ~= LocalPlayer.Team and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local playerRootPart = player.Character.HumanoidRootPart
                local distance = (LocalPlayer.Character.HumanoidRootPart.Position - playerRootPart.Position).Magnitude

                if distance < shortestDistance then
                    shortestDistance = distance
                    nearestPlayer = player
                end
            end
        end

        -- Teleport to the nearest enemy player if found
        if nearestPlayer and nearestPlayer.Character and nearestPlayer.Character:FindFirstChild("Head") then
            local targetHeadPosition = nearestPlayer.Character.Head.Position
            local newCFrame = CFrame.new(targetHeadPosition + Vector3.new(0, teleportHeight, 0))

            -- Check if the teleport location is valid
            local success, result = pcall(function()
                return workspace:FindPartOnRay(Ray.new(newCFrame.Position, Vector3.new(0, -teleportHeight * 2, 0)))
            end)

            if success and result then
                LocalPlayer.Character:SetPrimaryPartCFrame(newCFrame)
            else
                print("Teleport location is invalid or obstructed.")
            end
        end
        RunService.RenderStepped:Wait() -- Ensure this runs as often as possible
        if not tpToEnemyEnabled then break end -- Stop the loop if TP to Enemy is disabled
    end
end

--// GUI Setup
if game.PlaceId == 286090429 then
    local OrionLib = loadstring(game:HttpGet('https://raw.githubusercontent.com/shlexware/Orion/main/source'))()
    local Window = OrionLib:MakeWindow({Name = "ScytheSploits-Arsenalbeta", HidePremium = false, SaveConfig = false, ConfigFolder = "OrionTest"})

    local MainTab = Window:MakeTab({
        Name = "Main",
        Icon = "rbxassetid://4483345998",
        PremiumOnly = false
    })

    local CombatTab = Window:MakeTab({
        Name = "Combat",
        Icon = "rbxassetid://4483345998",
        PremiumOnly = false
    })

    local AimbotSection = CombatTab:AddSection({
        Name = "Aimbot",
        Icon = "rbxassetid://4483345998"
    })

    local MicsSection = CombatTab:AddSection({
        Name = "Mics",
        Icon = "rbxassetid://4483345998"
    })

    -- Main Tab
    MainTab:AddLabel("This tab is reserved for future features.")

    -- Aimbot Section
    AimbotSection:AddDropdown({
        Name = "Aimbot Target",
        Default = "Head",
        Options = {"Head", "HumanoidRootPart", "Torso"},
        Callback = function(option)
            aimAtPart = option
        end
    })

    AimbotSection:AddToggle({
        Name = "Aimbot",
        Default = false,
        Callback = function(Value)
            aimbotEnabled = Value
            if aimbotEnabled then
                aimAtTarget()
            end
        end    
    })

    AimbotSection:AddToggle({
        Name = "TP to Enemy",
        Default = false,
        Callback = function(Value)
            tpToEnemyEnabled = Value
            if tpToEnemyEnabled then
                tpToEnemy()
            end
        end    
    })

    -- Mics Section
    MicsSection:AddToggle({
        Name = "ESP",
        Default = false,
        Callback = function(Value)
            espEnabled = Value
            if espEnabled then
                enableNewESP()
                monitorNewPlayers()
            end
        end    
    })

    MicsSection:AddToggle({
        Name = "Infinite Ammo",
        Default = false,
        Callback = function(Value)
            infiniteAmmoEnabled = Value
            if infiniteAmmoEnabled then
                updateAmmo()
            end
        end    
    })

    MicsSection:AddToggle({
        Name = "Silent Aim",
        Default = false,
        Callback = function(Value)
            silentAimEnabled = Value
        end    
    })

    MicsSection:AddLabel("Silent Aim is not working, script is in beta mod.")

    -- Mics Tab
    local MicsTab = Window:MakeTab({
        Name = "Mics",
        Icon = "rbxassetid://4483345998",
        PremiumOnly = false
    })

    MicsTab:AddToggle({
        Name = "Infinite Jump",
        Default = false,
        Callback = function(Value)
            InfiniteJumpEnabled = Value
        end    
    })

    MicsTab:AddToggle({
        Name = "Speed Hack",
        Default = false,
        Callback = function(Value)
            speedHackEnabled = Value
            if speedHackEnabled then
                getgenv().Enabled = true
                getgenv().Speed = speedHackSpeed -- Use adjustable speed
                loadstring(game:HttpGet("https://raw.githubusercontent.com/eclipsology/SimpleSpeed/main/SimpleSpeed.lua"))()
            else
                getgenv().Enabled = false -- Turn off speed hack
            end
        end    
    })

    MicsTab:AddSlider({
        Name = "Speed Hack Speed",
        Min = 50,
        Max = 500,
        Default = 100,
        Color = Color3.fromRGB(255, 0, 0),
        Increment = 1,
        ValueName = "Speed",
        Callback = function(Value)
            speedHackSpeed = Value
        end    
    })

    OrionLib:Init()
end

--// Infinite Jump Logic
UserInputService.JumpRequest:Connect(function()
    if InfiniteJumpEnabled then
        LocalPlayer.Character:FindFirstChildOfClass('Humanoid'):ChangeState("Jumping")
    end
end)

--// Update FOV Circle Continuously
RunService.RenderStepped:Connect(updateFovCircle)

-- Run the anti-cheat bypass at the start
detectAndBypassAntiCheat()
